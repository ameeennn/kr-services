<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KR Services - Home Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .fade-in { opacity: 1; transition: opacity 0.3s ease-in-out; }
        .fade-out { opacity: 0; transition: opacity 0.3s ease-in-out; }
        .service-card:hover { transform: translateY(-5px); transition: transform 0.3s ease; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .hero-title { font-size: 1.875rem; line-height: 2.25rem; }
            .hero-subtitle { font-size: 1rem; }
            .service-card { margin-bottom: 1.5rem; }
            .container { padding-left: 1rem; padding-right: 1rem; }
        }
        @media (max-width: 640px) {
            .hero-title { font-size: 1.5rem; line-height: 2rem; }
            .hero-subtitle { font-size: 0.875rem; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-xl sm:text-2xl font-bold text-blue-600">KR Services</h1>
                </div>
                
                <!-- Language Toggle -->
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button onclick="changeLanguage('en')" class="px-2 py-1 sm:px-3 sm:py-1 rounded-md text-xs sm:text-sm font-medium transition-colors" id="en-btn">En</button>
                        <button onclick="changeLanguage('ml')" class="px-2 py-1 sm:px-3 sm:py-1 rounded-md text-xs sm:text-sm font-medium transition-colors" id="ml-btn">Mal</button>
                    </div>
                    
                    <!-- Auth Buttons -->
                    <div id="authButtons" class="flex">
                        <button onclick="openLoginModal()" class="px-3 py-2 sm:px-6 sm:py-2 text-blue-600 hover:bg-blue-50 rounded-lg text-xs sm:text-sm font-medium">Sign In</button>
                    </div>
                    
                    <!-- User Menu (hidden by default) -->
                    <div id="userMenu" class="hidden flex items-center space-x-2 sm:space-x-4">
                        <div class="flex items-center space-x-2">
                            <div id="userAvatar" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gray-400 flex items-center justify-center">
                                <i class="fas fa-user text-white text-xs sm:text-sm"></i>
                            </div>
                            <span id="userName" class="hidden sm:block text-sm font-medium text-gray-700">User</span>
                        </div>
                        <button onclick="logout()" class="px-2 py-1 sm:px-4 sm:py-2 text-red-600 hover:bg-red-50 rounded-lg text-xs sm:text-sm font-medium">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-12 sm:py-16">
        <div class="container mx-auto px-4 text-center">
            <h2 id="hero-title" class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold mb-4 hero-title px-2">Find Trusted Local Service Providers</h2>
            <p id="hero-subtitle" class="text-base sm:text-lg md:text-xl mb-8 hero-subtitle px-4 max-w-3xl mx-auto">Book professional services for your home with just a few clicks. Quality guaranteed!</p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 px-4">
                <a href="#services" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-300">Browse Services</a>
                <a href="track_service.html" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition duration-300">Track Service</a>
            </div>
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="py-12 sm:py-16">
        <div class="container mx-auto px-4">
            <h2 id="services-title" class="text-2xl sm:text-3xl font-bold text-center mb-8 sm:mb-12">Our Services</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
                <!-- Home Cleaning -->
                <div class="service-card bg-white rounded-xl shadow-md overflow-hidden transition duration-300" onclick="selectService('Home Cleaning')">
                    <div class="h-48 bg-blue-100">
                        <img src="img/home-cleaning.webp" alt="Home Cleaning" class="w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Home Cleaning</h3>
                        <p class="text-gray-600 mb-4 text-sm sm:text-base">
                            Professional deep cleaning services for your home. We handle kitchens, bathrooms, living areas, and more.
                        </p>
                        <button class="w-full py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 font-medium">
                            Book Now
                        </button>
                    </div>
                </div>
                <!-- AC Repair -->
                <div class="service-card bg-white rounded-xl shadow-md overflow-hidden transition duration-300" onclick="selectService('AC Repair')">
                    <div class="h-48 bg-green-100">
                        <img src="img/ac-repair.webp" alt="AC Repair" class="w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">AC Repair</h3>
                        <p class="text-gray-600 mb-4">
                            Expert AC repair and maintenance services by certified technicians. Get your cooling system running smoothly.
                        </p>
                        <button class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                            Book Now
                        </button>
                    </div>
                </div>

                <!-- Plumbing -->
                <div class="service-card bg-white rounded-xl shadow-md overflow-hidden transition duration-300" onclick="selectService('Plumbing')">
                    <div class="h-48 bg-yellow-100">
                        <img src="img/plumbing.webp" alt="Plumbing" class="w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Plumbing</h3>
                        <p class="text-gray-600 mb-4">
                            Fix leaks, unclog drains, and solve all plumbing issues with our experienced plumbers.
                        </p>
                        <button class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                            Book Now
                        </button>
                    </div>
                </div>

                <!-- Electrical Work -->
                <div class="service-card bg-white rounded-xl shadow-md overflow-hidden transition duration-300" onclick="selectService('Electrical Work')">
                    <div class="h-48 bg-purple-100">
                        <img src="img/electrical.webp" alt="Electrical Work" class="w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Electrical</h3>
                        <p class="text-gray-600 mb-4">
                            Safe and reliable electrical repairs, installations, and maintenance for your home.
                        </p>
                        <button class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                            Book Now
                        </button>
                    </div>
                </div>

                <!-- Painting -->
                <div class="service-card bg-white rounded-xl shadow-md overflow-hidden transition duration-300" onclick="selectService('Painting')">
                    <div class="h-48 bg-red-100">
                        <img src="img/painting.webp" alt="Painting" class="w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Painting</h3>
                        <p class="text-gray-600 mb-4">
                            Interior and exterior painting services by skilled professionals using quality materials.
                        </p>
                        <button class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                            Book Now
                        </button>
                    </div>
                </div>
                <!-- Appliance Repair -->
                <div class="service-card bg-white rounded-xl shadow-md overflow-hidden transition duration-300" onclick="selectService('Appliance Repair')">
                    <div class="h-48 bg-indigo-100">
                        <img src="img/appliance-repair.webp" alt="Appliance Repair" class="w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Appliance Repair</h3>
                        <p class="text-gray-600 mb-4">
                            Repair services for all major home appliances - refrigerators, washing machines, and more.
                        </p>
                        <button class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                            Book Now
                        </button>
                    </div>
                </div>
            </div>
            <!-- Additional Navigation -->
            <div class="mt-12 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                <a href="track_service.html" class="px-6 py-3 bg-white text-blue-600 border border-blue-600 rounded-lg font-medium hover:bg-blue-50 transition duration-300 text-center">
                    <i class="fas fa-map-marker-alt mr-2"></i> Track Your Service
                </a>
                <a href="provider.html" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition duration-300 text-center">
                    <i class="fas fa-user-plus mr-2"></i> Become a Provider
                </a>
            </div>
        </div>
    </section>
    
     <!-- Features Section -->
    <section class="py-12 md:py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-12">Why Choose ServiceHub?</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center px-4">
                    <div class="bg-blue-100 w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-shield-alt text-2xl text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Verified Professionals</h3>
                    <p class="text-gray-600">
                        All our service providers are thoroughly vetted and background-checked for your safety.
                    </p>
                </div>
                
                <div class="text-center px-4">
                    <div class="bg-green-100 w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-rupee-sign text-2xl text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Transparent Pricing</h3>
                    <p class="text-gray-600">
                        No hidden charges. Get upfront pricing before you book any service.
                    </p>
                </div>
                
                <div class="text-center px-4">
                    <div class="bg-purple-100 w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-headset text-2xl text-purple-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">24/7 Support</h3>
                    <p class="text-gray-600">
                        Our customer support team is always available to assist you with any queries.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-4">ServiceHub</h3>
                    <p class="text-gray-400">
                        Your trusted partner for all home service needs. Quality service at your doorstep.
                    </p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white">Home</a></li>
                        <li><a href="#services" class="text-gray-400 hover:text-white">Services</a></li>
                        <li><a href="track_service.html" class="text-gray-400 hover:text-white">Track Service</a></li>
                        <li><a href="provider.html" class="text-gray-400 hover:text-white">Become a Provider</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">Contact Us</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li class="flex items-center">
                            <i class="fas fa-phone-alt mr-2"></i> +91 9876543210
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-2"></i> support@servicehub.com
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2"></i> Kochi, Kerala
                        </li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">Follow Us</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white">
                            <i class="fab fa-facebook-f text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white">
                            <i class="fab fa-instagram text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white">
                            <i class="fab fa-linkedin-in text-xl"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2023 ServiceHub. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="loginModal" class="modal fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 fade-out hidden" onclick="closeModal('loginModal')">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Sign In</h3>
                    <button onclick="closeModal('loginModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form onsubmit="loginUser(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email or Phone</label>
                        <input type="text" id="loginEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter email or phone number">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button type="submit" id="loginBtn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                        Sign In
                    </button>
                    
                    <div class="mt-4 text-center">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">Or</span>
                            </div>
                        </div>
                        <button type="button" onclick="signInWithGoogle()" class="mt-4 w-full py-2 px-4 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition duration-300 flex items-center justify-center shadow-sm">
                            <svg class="h-5 w-5 mr-2" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Sign in with Google
                        </button>
                    </div>
                    
                    <div class="text-center text-sm mt-4">
                        <span class="text-gray-600">Don't have an account? </span>
                        <button type="button" onclick="switchToSignup()" class="text-blue-600 hover:underline">Sign up</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 fade-out hidden" onclick="closeModal('signupModal')">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Create Account</h3>
                    <button onclick="closeModal('signupModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form onsubmit="registerUser(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="signupName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="signupPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+91 9876543210">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email (Optional)</label>
                        <input type="email" id="signupEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="signupPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button type="submit" id="signupBtn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                        Create Account
                    </button>
                    
                    <div class="mt-4 text-center">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">Or</span>
                            </div>
                        </div>
                        <button type="button" onclick="signInWithGoogle()" class="mt-4 w-full py-2 px-4 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition duration-300 flex items-center justify-center shadow-sm">
                            <svg class="h-5 w-5 mr-2" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Sign up with Google
                        </button>
                    </div>
                    
                    <div class="text-center text-sm mt-4">
                        <span class="text-gray-600">Already have an account? </span>
                        <button type="button" onclick="switchToLogin()" class="text-blue-600 hover:underline">Sign in</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Auth Required Modal -->
    <div id="authRequiredModal" class="modal fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 fade-out hidden" onclick="closeModal('authRequiredModal')">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                        <i class="fas fa-exclamation text-blue-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Authentication Required</h3>
                    <p class="text-gray-600 mb-6">You need to sign in to book this service.</p>
                    
                    <div class="flex flex-col space-y-3">
                        <button onclick="closeModal('authRequiredModal'); openLoginModal();" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Sign In
                        </button>
                        <button onclick="closeModal('authRequiredModal'); openSignupModal();" class="w-full py-2 px-4 bg-white border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50">
                            Create Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLanguage = 'en';
        let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await checkExistingSession();
            updateAuthUI();
            changeLanguage(currentLanguage);
            
            // Initialize Google Auth when page loads
            window.addEventListener('load', function() {
                if (typeof google !== 'undefined' && google.accounts) {
                    initializeGoogleAuth();
                } else {
                    console.error('Google Sign-In library not loaded');
                }
            });
        });

        // Check for existing Supabase session
        async function checkExistingSession() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Session check error:', error);
                    return;
                }

                if (session && session.user) {
                    // Get user profile from users table
                    const { data: userProfile, error: profileError } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();

                    if (!profileError && userProfile) {
                        currentUser = {
                            id: session.user.id,
                            email: session.user.email,
                            name: userProfile.full_name,
                            phone: userProfile.phone,
                            picture: userProfile.profile_picture,
                            authMethod: userProfile.auth_method
                        };
                        
                        isLoggedIn = true;
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Update button styles
            document.getElementById('en-btn').className = lang === 'en' ? 
                'px-3 py-1 rounded-md text-sm font-medium bg-white text-blue-600 shadow-sm' : 
                'px-3 py-1 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800';
            document.getElementById('ml-btn').className = lang === 'ml' ? 
                'px-3 py-1 rounded-md text-sm font-medium bg-white text-blue-600 shadow-sm' : 
                'px-3 py-1 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800';

            if (lang === 'ml') {
                document.getElementById('hero-title').textContent = 'വിശ്വസനീയമായ പ്രാദേശിക സേവന ദാതാക്കളെ കണ്ടെത്തുക';
                document.getElementById('hero-subtitle').textContent = 'നിങ്ങളുടെ വീട്ടിനായി പ്രൊഫഷണൽ സേവനങ്ങൾ ബുക്ക് ചെയ്യുക. ഗുണനിലവാരം ഉറപ്പാക്കുന്നു!';
                document.getElementById('services-title').textContent = 'ഞങ്ങളുടെ സേവനങ്ങൾ';
            } else {
                document.getElementById('hero-title').textContent = 'Find Trusted Local Service Providers';
                document.getElementById('hero-subtitle').textContent = 'Book professional services for your home with just a few clicks. Quality guaranteed!';
                document.getElementById('services-title').textContent = 'Our Services';
            }
        }

        function updateAuthUI() {
            if (isLoggedIn) {
                document.getElementById('authButtons').classList.add('hidden');
                document.getElementById('userMenu').classList.remove('hidden');
                document.getElementById('userName').textContent = currentUser.name || currentUser.email || 'User';
                
                // Update avatar
                const avatar = document.getElementById('userAvatar');
                if (currentUser.picture) {
                    // Google user - show profile picture
                    avatar.innerHTML = `<img src="${currentUser.picture}" alt="Profile" class="w-8 h-8 rounded-full">`;
                } else {
                    // Email user - show grey placeholder
                    avatar.innerHTML = '<i class="fas fa-user text-white text-sm"></i>';
                    avatar.className = 'w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center';
                }
            } else {
                document.getElementById('authButtons').classList.remove('hidden');
                document.getElementById('userMenu').classList.add('hidden');
            }
        }

        function selectService(serviceName) {
            if (!isLoggedIn) {
                openAuthRequiredModal();
                return;
            }
            
            // Store selected service and redirect
            localStorage.setItem('selectedService', serviceName);
            window.location.href = 'confirm_service.html';
        }

        function openLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.remove('hidden', 'fade-out');
            modal.classList.add('fade-in');
        }

        function openSignupModal() {
            const modal = document.getElementById('signupModal');
            modal.classList.remove('hidden', 'fade-out');
            modal.classList.add('fade-in');
        }

        function openAuthRequiredModal() {
            const modal = document.getElementById('authRequiredModal');
            modal.classList.remove('hidden', 'fade-out');
            modal.classList.add('fade-in');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('fade-in');
            modal.classList.add('fade-out');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.classList.remove('fade-in');
                modal.classList.add('fade-out', 'hidden');
            });
        }

        function switchToSignup() {
            closeModal('loginModal');
            setTimeout(() => openSignupModal(), 350);
        }

        function switchToLogin() {
            closeModal('signupModal');
            setTimeout(() => openLoginModal(), 350);
        }

        async function loginUser(event) {
            event.preventDefault();
            const emailOrPhone = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            // Set loading state
            setButtonLoading(loginBtn, true, 'Signing In...');

            try {
                let loginEmail = emailOrPhone;
                
                // If input looks like phone number, find associated email
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailOrPhone)) {
                    // It's a phone number, find the user's email
                    const { data: phoneUser, error: profileError } = await supabaseClient
                        .from('users')
                        .select('email, phone, auth_method')
                        .eq('phone', emailOrPhone)
                        .maybeSingle();

                    if (!phoneUser) {
                        throw new Error('Phone number not found. Please check your phone number.');
                    }
                    
                    // Check if user signed up with Google
                    if (phoneUser.auth_method === 'google') {
                        throw new Error('This phone number is associated with a Google account. Please sign in with Google.');
                    }
                    
                    // Use the generated email for auth
                    loginEmail = phoneUser.email || `${emailOrPhone.replace(/[^0-9]/g, '')}@krservices.local`;
                } else {
                    // It's an email, check if user signed up with Google
                    const { data: emailUser, error: emailError } = await supabaseClient
                        .from('users')
                        .select('auth_method')
                        .eq('email', emailOrPhone)
                        .maybeSingle();
                    
                    if (emailUser && emailUser.auth_method === 'google') {
                        throw new Error('This email is associated with a Google account. Please sign in with Google.');
                    }
                }

                // Sign in with Supabase Auth
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: loginEmail,
                    password: password
                });

                if (error) throw error;

                // Get user profile from users table
                const { data: profile, error: profileError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();

                if (profileError) {
                    console.error('Profile fetch error:', profileError);
                }

                currentUser = {
                    id: data.user.id,
                    email: profile?.email,
                    phone: profile?.phone,
                    name: profile?.full_name || 'User',
                    authMethod: profile?.auth_method || 'phone'
                };

                isLoggedIn = true;
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                updateAuthUI();
                closeModal('loginModal');
                console.log('Successfully logged in!');
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            } finally {
                setButtonLoading(loginBtn, false, 'Sign In');
            }
        }

        async function registerUser(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const phone = document.getElementById('signupPhone').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const signupBtn = document.getElementById('signupBtn');

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            setButtonLoading(signupBtn, true, 'Creating Account...');

            try {
                // Check if phone already exists
                const { data: existingPhone } = await supabaseClient
                    .from('users')
                    .select('phone')
                    .eq('phone', phone)
                    .maybeSingle();

                if (existingPhone) {
                    throw new Error('Phone number already registered. Please use a different phone number.');
                }

                // Check if email already exists (if provided)
                if (email) {
                    const { data: existingEmail } = await supabaseClient
                        .from('users')
                        .select('email')
                        .eq('email', email)
                        .maybeSingle();

                    if (existingEmail) {
                        throw new Error('Email already registered. Please use a different email.');
                    }
                }

                // Use phone as primary identifier, create email if not provided
                const userEmail = email || `${phone.replace(/[^0-9]/g, '')}@krservices.local`;
                
                // Sign up with Supabase Auth (auto-confirm)
                const { data, error } = await supabaseClient.auth.signUp({
                    email: userEmail,
                    password: password,
                    options: {
                        emailRedirectTo: undefined,
                        data: {
                            full_name: name,
                            phone: phone
                        },
                        captchaToken: undefined
                    }
                });

                if (error) throw error;

                // If user created but not auto-logged in, sign them in
                if (data.user && !data.session) {
                    const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: userEmail,
                        password: password
                    });
                    
                    if (signInError) {
                        console.error('Auto sign-in failed:', signInError);
                    } else {
                        data.session = signInData.session;
                    }
                }

                // Insert user profile into users table
                const { error: insertError } = await supabaseClient
                    .from('users')
                    .insert({
                        id: data.user.id,
                        email: email || null,
                        phone: phone,
                        full_name: name,
                        auth_method: email ? 'email' : 'phone'
                    });

                if (insertError) {
                    console.error('Profile creation error:', insertError);
                    throw new Error('Failed to create user profile: ' + insertError.message);
                }

                // Auto-login after successful registration
                currentUser = {
                    id: data.user.id,
                    email: email,
                    phone: phone,
                    name: name,
                    authMethod: email ? 'email' : 'phone'
                };

                isLoggedIn = true;
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                updateAuthUI();
                closeModal('signupModal');
                alert('Account created and logged in successfully!');
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed: ' + error.message);
            } finally {
                setButtonLoading(signupBtn, false, 'Create Account');
            }
        }

        // Supabase Configuration
        const supabaseUrl = 'https://imdrjtjlpuqdixvpdytk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZHJqdGpscHVxZGl4dnBkeXRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzExMTcsImV4cCI6MjA3MTYwNzExN30.Sa8UFkFyLKTL-JLzaojq9whdq3VjHFqxSVlWY_W4HkU';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        
        // Google OAuth Configuration
        let googleAuth = null;
        
        // Initialize Google OAuth
        function initializeGoogleAuth() {
            try {
                google.accounts.id.initialize({
                    client_id: '403529757349-vu7hdavb3eghco76hr977r4jekr8b9jt.apps.googleusercontent.com',
                    callback: handleGoogleSignIn,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });
                console.log('Google Sign-In initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Google Sign-In:', error);
            }
        }
        
        function signInWithGoogle() {
            try {
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.prompt((notification) => {
                        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                            // Fallback to renderButton if prompt fails
                            renderGoogleSignInButton();
                        }
                    });
                } else {
                    alert('Google Sign-In is not available. Please try again later.');
                }
            } catch (error) {
                console.error('Google Sign-In error:', error);
                alert('Google Sign-In failed. Please try again.');
            }
        }
        
        function renderGoogleSignInButton() {
            // Create a temporary container for Google button
            const tempDiv = document.createElement('div');
            tempDiv.id = 'google-signin-temp';
            document.body.appendChild(tempDiv);
            
            google.accounts.id.renderButton(tempDiv, {
                theme: 'outline',
                size: 'large',
                width: '100%'
            });
            
            // Trigger click on the rendered button
            setTimeout(() => {
                const googleBtn = tempDiv.querySelector('div[role="button"]');
                if (googleBtn) {
                    googleBtn.click();
                }
                document.body.removeChild(tempDiv);
            }, 100);
        }
        
        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event, session);
            
            if (event === 'SIGNED_IN' && session) {
                await checkExistingSession();
                updateAuthUI();
            } else if (event === 'SIGNED_OUT') {
                isLoggedIn = false;
                currentUser = {};
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                updateAuthUI();
            }
        });

        function setButtonLoading(button, isLoading, text) {
            if (isLoading) {
                button.disabled = true;
                button.classList.add('bg-gray-400', 'cursor-not-allowed');
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${text}`;
            } else {
                button.disabled = false;
                button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                button.innerHTML = text;
            }
        }

        function generateUserId() {
            return crypto.randomUUID();
        }
        
        async function handleGoogleSignIn(response) {
            try {
                console.log('Google Sign-In response received:', response);
                
                if (!response || !response.credential) {
                    throw new Error('Invalid Google Sign-In response');
                }
                
                // Decode JWT token
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                console.log('Google user payload:', payload);
                
                // Check if email already exists with different auth method
                const { data: existingUser } = await supabaseClient
                    .from('users')
                    .select('auth_method, email')
                    .eq('email', payload.email)
                    .maybeSingle();
                
                if (existingUser && existingUser.auth_method !== 'google') {
                    throw new Error('This email is already registered with email/password. Please sign in with your password.');
                }
                
                // Sign in with Supabase using Google ID token
                const { data, error } = await supabaseClient.auth.signInWithIdToken({
                    provider: 'google',
                    token: response.credential
                });

                if (error) {
                    // Fallback: create user manually
                    console.log('Supabase Google auth failed, creating user manually');
                    await handleGoogleSignInFallback(payload);
                    return;
                }

                // Check if user exists in users table
                let { data: userProfile, error: profileError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', payload.email)
                    .maybeSingle();

                // If user doesn't exist, create profile
                if (!userProfile) {
                    const { error: insertError } = await supabaseClient
                        .from('users')
                        .insert({
                            id: data.user.id,
                            email: payload.email,
                            full_name: payload.name,
                            google_id: payload.sub,
                            profile_picture: payload.picture,
                            auth_method: 'google',
                            is_verified: true
                        });

                    if (!insertError) {
                        userProfile = {
                            email: payload.email,
                            full_name: payload.name,
                            google_id: payload.sub,
                            profile_picture: payload.picture,
                            auth_method: 'google'
                        };
                    }
                }
                
                currentUser = {
                    id: data.user.id,
                    name: userProfile?.full_name || payload.name,
                    email: payload.email,
                    picture: userProfile?.profile_picture || payload.picture,
                    googleId: payload.sub,
                    authMethod: 'google'
                };
                
                isLoggedIn = true;
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                console.log('User signed in successfully:', currentUser);
                updateAuthUI();
                closeAllModals();
                alert('Successfully signed in with Google!');
            } catch (error) {
                console.error('Google sign-in error:', error);
                alert('Google sign-in failed: ' + error.message + '. Please try again.');
            }
        }

        async function handleGoogleSignInFallback(payload) {
            try {
                // Check if user already exists
                const { data: existingUser } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', payload.email)
                    .maybeSingle();

                if (existingUser && existingUser.auth_method !== 'google') {
                    throw new Error('This email is already registered with email/password. Please sign in with your password.');
                }

                if (!existingUser) {
                    // Create new user with generated ID
                    const userId = generateUserId();
                    const { error: insertError } = await supabaseClient
                        .from('users')
                        .insert({
                            id: userId,
                            email: payload.email,
                            full_name: payload.name,
                            google_id: payload.sub,
                            profile_picture: payload.picture,
                            auth_method: 'google',
                            is_verified: true
                        });

                    if (insertError) throw insertError;
                }

                currentUser = {
                    id: existingUser?.id || generateUserId(),
                    name: payload.name,
                    email: payload.email,
                    picture: payload.picture,
                    googleId: payload.sub,
                    authMethod: 'google'
                };
                
                isLoggedIn = true;
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                updateAuthUI();
                closeAllModals();
                alert('Successfully signed in with Google!');
            } catch (error) {
                console.error('Google fallback error:', error);
                throw error;
            }
        }

        async function logout() {
            try {
                // Sign out from Supabase
                const { error } = await supabaseClient.auth.signOut();
                if (error) console.error('Supabase logout error:', error);
                
                isLoggedIn = false;
                currentUser = {};
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                updateAuthUI();
                alert('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
                // Still clear local state even if Supabase logout fails
                isLoggedIn = false;
                currentUser = {};
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                updateAuthUI();
            }
        }
    </script>
</body>
</html>
